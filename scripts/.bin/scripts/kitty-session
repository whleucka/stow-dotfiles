#!/usr/bin/env bash

SESSION_DIR="${HOME}/.config/kitty/sessions"
mkdir -p "$SESSION_DIR"

# List existing session names without extension
SESSIONS=$(ls "$SESSION_DIR"/*.conf 2>/dev/null | sed 's#.*/##; s#.conf$##')

SESSION_NAME=$(printf "%s\n" $SESSIONS | \
  fzf --prompt="Kitty sessions > " --height=50% --border --reverse \
      --bind "alt-c:execute(echo -n '{q}' > /tmp/kitty-new-session)+abort" \
      --header="Press ALT-C to create a new session")

# ALT-C pressed â†’ user typed a new name
if [ -f "/tmp/kitty-new-session" ]; then
    SESSION_NAME=$(cat /tmp/kitty-new-session)
    rm /tmp/kitty-new-session
fi

# If nothing selected, bail
[ -z "$SESSION_NAME" ] && exit 0

SESSION_TEMPLATE="${SESSION_DIR}/${SESSION_NAME}.conf"
SESSION_LATEST="${SESSION_DIR}/${SESSION_NAME}.latest"

# Create template if not exists
if [ ! -f "$SESSION_TEMPLATE" ]; then
    cat > "$SESSION_TEMPLATE" <<EOF
# Kitty session: $SESSION_NAME
launch zsh
EOF
fi

# Load latest saved state if it exists
if [ -f "$SESSION_LATEST" ]; then
    kitty --session "$SESSION_LATEST"
else
    kitty --session "$SESSION_TEMPLATE"
fi
